<%- include('partials/header.ejs') %>
<link rel="stylesheet" href="/styles/coin.css">

<body class="text-bg-dark">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark my-5">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">PREX</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/prices">Prices</a>
                    </li>
                </ul>
                <form class="d-flex ms-3" role="search" action="/search" method="GET">
                    <input class="form-control me-2" type="search" placeholder="Search coins..." aria-label="Search" name="query">
                    <button class="btn btn-outline-secondary" type="submit">
                        <i class="bi bi-search">Search</i>
                    </button>
                </form>
                <div class="d-lg-flex col-lg-3 justify-content-lg-end"> 
                    <button class="btn btn-primary">Log In</button>
                </div>
            </div>
        </div> 
    </nav>
    <ul class="d-flex flex-wrap list-unstyled justify-content-center coin-layout">
        <% if(locals.coin) { %>
        <li class="list-group-item mb-0 p-2 mx-2 w-100">
            <div class="col d-flex justify-content-center"> 
                <div class="card shadow-sm coin-card" style="background:#15181d; border:1px solid #2b3138;"> 
                    <%
                        const plotW = 300;
                        const chartH = 120;
                        const viewW = 340;
                        const viewH = 150;
                        const pad = 10;
                        const lineColor = '#f2c200';
                        const tickCount = 8;
                        const min = coin.sparklineMin;
                        const max = coin.sparklineMax;
                        const range = (min !== null && max !== null) ? (max - min) || 1 : 1;
                        const ticks = [];
                        for (let i = 0; i < tickCount; i++) {
                            const y = pad + (i / (tickCount - 1)) * (chartH - pad * 2);
                            const value = max !== null ? (max - (range * i) / (tickCount - 1)) : 0;
                            ticks.push({ y, value });
                        }
                        const now = new Date();
                        const start = new Date(now);
                        start.setDate(now.getDate() - 7);
                        const dateLabels = [];
                        for (let i = 0; i <= 7; i++) {
                            const d = new Date(start);
                            d.setDate(start.getDate() + i);
                            const x = pad + (i / 7) * (plotW - pad * 2);
                            dateLabels.push({
                                x,
                                day: d.getDate(),
                                month: (i === 0 || d.getDate() === 1) ? d.toLocaleString('en-US', { month: 'short' }) : ''
                            });
                        }
                    %>
                    <svg class="card-img-top coin-chart" viewBox="0 0 340 150" role="img" aria-label="Price (7D)" preserveAspectRatio="xMidYMid meet" width="100%" xmlns="http://www.w3.org/2000/svg">
                        <rect width="340" height="150" fill="#14181e"></rect>

                        <% ticks.forEach(t => { %>
                            <line x1="<%= pad %>" y1="<%= t.y %>" x2="<%= plotW - pad %>" y2="<%= t.y %>" stroke="#2a3138" stroke-width="1" />
                        <% }); %>

                        <% if (coin.sparklineLinePath) { %>
                            <path d="<%= coin.sparklineLinePath %>" fill="none" stroke="<%= lineColor %>" stroke-width="1.8"></path>
                        <% } else { %>
                            <text x="150" y="70" text-anchor="middle" fill="#98a6b3" font-size="12" font-family="system-ui, -apple-system, Segoe UI, sans-serif">No data</text>
                        <% } %>

                        <text x="<%= viewW - 6 %>" y="8" text-anchor="end" fill="#d6d9dd" font-size="9" font-family="system-ui, -apple-system, Segoe UI, sans-serif">USD</text>

                        <% ticks.forEach(t => { %>
                            <text x="<%= viewW - 6 %>" y="<%= t.y + 6 %>" text-anchor="end" fill="#b8c0c8" font-size="9" font-family="system-ui, -apple-system, Segoe UI, sans-serif">
                                <%= t.value >= 1000 ? (t.value / 1000).toFixed(2) + 'K' : t.value.toFixed(2) %>
                            </text>
                        <% }); %>

                        <% dateLabels.forEach(d => { %>
                            <text x="<%= d.x %>" y="144" text-anchor="middle" fill="#8f98a1" font-size="9" font-family="system-ui, -apple-system, Segoe UI, sans-serif"><%= d.day %></text>
                            <% if (d.month) { %>
                                <text x="<%= d.x %>" y="132" text-anchor="middle" fill="#8f98a1" font-size="9" font-family="system-ui, -apple-system, Segoe UI, sans-serif"><%= d.month %></text>
                            <% } %>
                        <% }); %>
                    </svg>
                    <div class="d-flex align-items-center justify-content-between px-3 py-2" style="background:#1b2026; border-top:1px solid #2b3138;">
                        <div class="text-light small">
                            <strong><%= coin.symbol.toUpperCase() %></strong>: $<%= coin.current_price.toFixed(3) %>
                        </div>
                        <a type="button" class="btn btn-sm btn-outline-primary" href="/prices">Go Back</a>
                        <div class="text-secondary small">
                            <%= new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %>
                        </div>
                    </div>
                </div>
            </div>
        </li>
        <% } else { %>
            <li>No coin data available.</li>
        <% } %>
        <% if(locals.error) { %>
            <li>Error: <%= locals.error.message %></li>
        <% } %>
    </ul>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>


<%-include("partials/footer.ejs")  %>